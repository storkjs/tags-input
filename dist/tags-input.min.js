!function(root){"use strict";var capitalizeWords=function(str){return str.replace(/\w\S*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()})},StorkTagsInput=function(options){this.tagsInput=options.element,this.suggestionsHandler=options.suggestionsHandler,this.rnd||(this.rnd=1e3*(Math.floor(9*Math.random())+1)+Date.now()%1e3),this.inputMinWidth=options.inputMinWidth||60,this.rechooseRemove=options.rechooseRemove||!1,this.placeholder=options.placeholder||"",this.textCanvasContext=null,this.focused=!1,this.chosenTags=[],this.focusedTagIndex=null,this.lastSearchString=null,this.tagDeleteThrottle={allowed:!0,TO:void 0},this.eventListeners=[],this.tagsInput.classList.add("stork-tags","stork-tags"+this.rnd),this.tagsInput.setAttribute("tabindex",0),this.buildDom(),this.setEventListeners()};StorkTagsInput.prototype._addEventListener=function(element,type,listener,options_or_useCapture){return element.addEventListener(type,listener,options_or_useCapture),this.eventListeners.push({element:element,type:type,listener:listener,options:options_or_useCapture}),this.eventListeners.length-1},StorkTagsInput.prototype._removeEventListener=function(index){var currEL=this.eventListeners[index];currEL&&currEL.element.removeEventListener(currEL.type,currEL.listener,currEL.options),this.eventListeners[index]=null},StorkTagsInput.prototype._emptyEventListeners=function(){for(var currEL,i=0;i<this.eventListeners.length;i++)currEL=this.eventListeners[i],currEL&&this._removeEventListener(i)},StorkTagsInput.prototype.addEventListener=function(type,listener,options_or_useCapture){this._addEventListener(this.tagsInput,type,listener,options_or_useCapture,!0)},StorkTagsInput.prototype.removeEventListener=function(type,listener,options_or_useCapture){this.tagsInput.removeEventListener(type,listener,options_or_useCapture);for(var i=0;i<this.eventListeners.length;i++)this.eventListeners[i].element===this.tagsInput&&this.eventListeners[i].type===type&&this.eventListeners[i].listener===listener&&(this.eventListeners[i]=null)},StorkTagsInput.prototype.buildDom=function(){this.ul=document.createElement("ul"),this.inputLi=document.createElement("li"),this.input=document.createElement("input"),this.inputLi.classList.add("search-li"),this.inputLi.storkTagsProps={state:null},this.input.classList.add("search"),this.input.storkTagsProps={paddingLeft:0,paddingRight:0},this.input.setAttribute("placeholder",this.placeholder),this.inputLi.appendChild(this.input),this.ul.appendChild(this.inputLi),this.tagsInput.appendChild(this.ul),this.dropdownContainer=document.createElement("div"),this.dropdownContainer.classList.add("stork-tags-dropdown-container","stork-tags-dropdown-container"+this.rnd),this.dropdownContainer.setAttribute("tabindex",0),this.dropdownContainer.storkTagsProps={allLIs:this.dropdownContainer.getElementsByTagName("li"),hoveredLIIndex:null},this.updateSearchState(),this.positionDropdown(),document.body.appendChild(this.dropdownContainer)},StorkTagsInput.prototype.setEventListeners=function(){this._addEventListener(this.input,"keyup",this.onChangeSearchInput.bind(this),!1),this._addEventListener(this.input,"keydown",this.onKeydownSearchInput.bind(this),!1),this._addEventListener(this.input,"focus",this.onFocusSearchInput.bind(this),!1),this._addEventListener(this.dropdownContainer,"click",this.onClickSuggestionsDropdown.bind(this),!1),this._addEventListener(this.dropdownContainer,"mousemove",this.onMouseMoveSuggestionsDropdown.bind(this),!1),this._addEventListener(this.ul,"click",this.onClickTagsArea.bind(this),!1),this._addEventListener(document,"click",this.onClickCheckFocus.bind(this),!0),this._addEventListener(document,"keyup",this.onKeyCheckFocus.bind(this),!0),this._addEventListener(this.tagsInput,"keydown",this.onSuggestionsKeyboardNavigate.bind(this),!1),this._addEventListener(this.dropdownContainer,"keydown",this.onSuggestionsKeyboardNavigate.bind(this),!1),this._addEventListener(this.tagsInput,"keyup",this.onKeyboardFocus.bind(this),!1),this._addEventListener(this.tagsInput,"keydown",this.onTagsKeyboardNavigate.bind(this),!1)},StorkTagsInput.prototype.positionDropdown=function(width){width?this.dropdownContainer.style.width=width+"px":this.dropdownContainer.style.width=this.tagsInput.offsetWidth+"px";var coordinates=this.tagsInput.getCoordinates();this.dropdownContainer.style.left=coordinates.x+"px",this.dropdownContainer.style.top=coordinates.y+this.tagsInput.offsetHeight+1+"px"},StorkTagsInput.prototype.suggestionsCallback=function(suggestionsArr){for(;this.dropdownContainer.firstChild;)this.dropdownContainer.removeChild(this.dropdownContainer.firstChild);if(0===suggestionsArr.length)return void this.dropdownContainer.classList.remove("has-results");var i,j,groupDiv,groupHeader,itemsList,item,miscElm;for(i=0;i<suggestionsArr.length;i++){for(groupDiv=document.createElement("div"),groupHeader=document.createElement("div"),miscElm=document.createElement("span"),itemsList=document.createElement("ul"),""!==suggestionsArr[i].label&&(miscElm.appendChild(document.createTextNode(suggestionsArr[i].label)),groupHeader.appendChild(miscElm)),j=0;j<suggestionsArr[i].items.length;j++)item=document.createElement("li"),item.storkTagsProps={value:suggestionsArr[i].items[j].value,label:suggestionsArr[i].items[j].label,groupField:suggestionsArr[i].field,groupLabel:suggestionsArr[i].label},miscElm=document.createElement("a"),miscElm.appendChild(document.createTextNode(suggestionsArr[i].items[j].label)),item.appendChild(miscElm),itemsList.appendChild(item);groupDiv.appendChild(groupHeader),groupDiv.appendChild(itemsList),this.dropdownContainer.appendChild(groupDiv)}this.dropdownContainer.storkTagsProps.hoveredLIIndex=null,this.onMouseMoveSuggestionsDropdown({target:this.dropdownContainer.storkTagsProps.allLIs[0]}),this.positionDropdown(),this.dropdownContainer.classList.add("has-results")},StorkTagsInput.prototype.onClickSuggestionsDropdown=function(e){for(var LI=e.target,i=0;!(LI instanceof HTMLDocument)&&"LI"!==LI.tagName.toUpperCase();){if(i++>=2)return;LI=LI.parentNode}this.addTag(LI.storkTagsProps),this.unfocusSuggestions(),this.input.value="",this.chosenTags.length>=1&&(this.suggestionsCallback([]),this.lastSearchString=""),this.input.focus()},StorkTagsInput.prototype._scrollSuggestionsDropdownByItem=function(LI){for(var yPos_bottomPart,yPos=0,elm=LI;elm&&elm!==this.dropdownContainer&&this.dropdownContainer.contains(elm);)yPos+=elm.offsetTop,elm=elm.offsetParent;yPos<this.dropdownContainer.scrollTop?this.dropdownContainer.scrollTop=yPos:(yPos_bottomPart=yPos+LI.clientHeight,this.dropdownContainer.scrollTop+this.dropdownContainer.clientHeight<yPos_bottomPart&&(this.dropdownContainer.scrollTop=yPos_bottomPart-this.dropdownContainer.clientHeight))},StorkTagsInput.prototype.onMouseMoveSuggestionsDropdown=function(e){var LI=e.target,i=0,self=this;if(!LI||!LI.tagName)return void console.error("event's target is not an HTMLElement");for(;!(LI instanceof HTMLDocument)&&"LI"!==LI.tagName.toUpperCase();){if(i++>=2)return;LI=LI.parentNode}var index=this.dropdownContainer.storkTagsProps.hoveredLIIndex;if(Number.isInteger(index)){var prevHoveredLI=this.dropdownContainer.storkTagsProps.allLIs[index];if(prevHoveredLI===LI)return;prevHoveredLI.classList.remove("focused")}for(i=0;i<this.dropdownContainer.storkTagsProps.allLIs.length;i++)if(LI===this.dropdownContainer.storkTagsProps.allLIs[i]){LI.classList.add("focused"),this.dropdownContainer.storkTagsProps.hoveredLIIndex=i,window.requestAnimationFrame(function(){self._scrollSuggestionsDropdownByItem(LI)});break}},StorkTagsInput.prototype.addTag=function(tagObj){var i;for("undefined"!=typeof tagObj.groupLabel&&null!==tagObj.groupLabel||(tagObj.groupLabel=capitalizeWords(tagObj.groupField)),tagObj.label||(tagObj.label=capitalizeWords(tagObj.value)),i=0;i<this.chosenTags.length;i++)if(tagObj.groupField===this.chosenTags[i].groupField&&tagObj.value===this.chosenTags[i].value){if(this.rechooseRemove){try{this.removeTag(i)}catch(e){return!1}return!0}return!1}var li=document.createElement("li"),xA=document.createElement("a"),groupSpan=document.createElement("span"),valueSpan=document.createElement("span");xA.appendChild(document.createTextNode("Ã—")),groupSpan.appendChild(document.createTextNode(tagObj.groupLabel)),valueSpan.appendChild(document.createTextNode(tagObj.label)),li.classList.add("tag"),xA.classList.add("remove"),groupSpan.classList.add("group"),valueSpan.classList.add("value"),li.appendChild(xA),""!==tagObj.groupLabel&&li.appendChild(groupSpan),li.appendChild(valueSpan),this.ul.insertBefore(li,this.inputLi);var tagIndex=li.index;this.chosenTags.splice(tagIndex,0,{value:tagObj.value,label:tagObj.label,groupField:tagObj.groupField,groupLabel:tagObj.groupLabel,elm:li}),this.updateSearchState(),document.activeElement===this.input&&(this.input.blur(),this.input.focus());var evnt=new CustomEvent("tag-added",{bubbles:!0,cancelable:!0,detail:{obj:this.chosenTags[tagIndex],index:tagIndex}});this.tagsInput.dispatchEvent(evnt)},StorkTagsInput.prototype.removeTag=function(index){if(!this.chosenTags[index])throw new Error("index does not exist in chosenTags array");this.unfocusTags(),this.ul.removeChild(this.chosenTags[index].elm);var removed=this.chosenTags.splice(index,1);0===this.chosenTags.length&&(this.updateSearchState(),this.lastSearchString=null);var evnt=new CustomEvent("tag-removed",{bubbles:!0,cancelable:!0,detail:{obj:removed[0],index:index}});this.tagsInput.dispatchEvent(evnt)},StorkTagsInput.prototype.removeAllTags=function(){for(this.unfocusTags();this.ul.firstChild;)this.ul.removeChild(this.ul.firstChild);this.ul.appendChild(this.inputLi);var removed=this.chosenTags.splice(0,this.chosenTags.length);0===this.chosenTags.length&&(this.updateSearchState(),this.lastSearchString=null);var evnt=new CustomEvent("all-tags-removed",{bubbles:!0,cancelable:!0,detail:{removedTags:removed}});return this.tagsInput.dispatchEvent(evnt),!0},StorkTagsInput.prototype.updateSearchState=function(){this.chosenTags.length>0?(this.inputLi.classList.add("with-tags"),this.inputLi.classList.remove("no-tags"),this.inputLi.storkTagsProps.state="with-tags",this.input.setAttribute("placeholder",""),this.calculateSearchInputWidth()):(this.inputLi.classList.add("no-tags"),this.inputLi.classList.remove("with-tags"),this.inputLi.storkTagsProps.state="no-tags",this.input.setAttribute("placeholder",this.placeholder),this.input.style.width="")},StorkTagsInput.prototype.onClickTagsArea=function(event){var elm=event.target,i=0;do{if("A"===elm.tagName.toUpperCase()&&elm.classList.contains("remove")){var elmIndex=elm.parentNode.index;this.inputLi.index<elmIndex&&elmIndex--;try{this.removeTag(elmIndex)}catch(e){console.warn(e.message)}finally{this.focusSearchInput(0)}return}if("LI"===elm.tagName.toUpperCase())return void(elm.classList.contains("tag")?this.onClickFocusTag(elm):elm===this.inputLi&&this.input.focus());if("UL"===elm.tagName.toUpperCase())return void this.redrawSearchInput(event.offsetX);elm=elm.parentNode,i++}while(i<=3&&!(elm instanceof HTMLDocument))},StorkTagsInput.prototype.onClickFocusTag=function(index){Number.isInteger(index)||(index=index.index,this.inputLi.index<index&&index--),Number.isInteger(this.focusedTagIndex)&&this.chosenTags[this.focusedTagIndex].elm.classList.remove("focused"),this.chosenTags[index].elm.classList.add("focused"),this.focusedTagIndex=index,this.tagsInput.focus(),this.scrollLIIntoView(this.chosenTags[index].elm)},StorkTagsInput.prototype.scrollLIIntoView=function(li){if(!this._tagLIMarginLeft){var liStyle,tagLi=this.ul.querySelector("li.tag");if(!tagLi)return;liStyle=tagLi.currentStyle||window.getComputedStyle(tagLi),this._tagLIMarginLeft=parseInt(liStyle.marginLeft,10)}var leftPos=li.offsetLeft,extra=20;this.tagsInput.scrollLeft=leftPos-this._tagLIMarginLeft-extra},StorkTagsInput.prototype.redrawSearchInput=function(x,caretPosition){if(0!==this.chosenTags.length){var idx,closestTagElm;for(idx=0;idx<this.chosenTags.length;idx++)(!closestTagElm||Math.abs(closestTagElm.offsetLeft-x)>Math.abs(this.chosenTags[idx].elm.offsetLeft-x))&&(closestTagElm=this.chosenTags[idx].elm);var append=this.chosenTags.last.elm===closestTagElm&&Math.abs(closestTagElm.offsetLeft-x)>Math.abs(closestTagElm.offsetLeft+closestTagElm.clientWidth-x);(append&&this.ul.lastChild!==this.inputLi||!append&&closestTagElm.previousSibling!==this.inputLi)&&(this.ul.removeChild(this.inputLi),this.input.value="",append?this.ul.appendChild(this.inputLi):this.ul.insertBefore(this.inputLi,closestTagElm)),"number"!=typeof caretPosition&&this.inputLi.offsetLeft<x&&(caretPosition=this.input.value.length),this.calculateSearchInputWidth(),this.focusSearchInput(caretPosition)}},StorkTagsInput.prototype.onClickCheckFocus=function(e){for(var evnt,target=e.target;!(target instanceof HTMLDocument)&&target!==this.tagsInput&&target!==this.dropdownContainer;)if(target=target.parentNode,target&&target instanceof HTMLDocument)return void(this.focused&&(this.focused=!1,this.tagsInput.classList.remove("focused"),this.dropdownContainer.classList.remove("focused"),""===this.input.value&&(this.lastSearchString=null),evnt=new CustomEvent("tags-input-blur",{bubbles:!0,cancelable:!0}),this.tagsInput.dispatchEvent(evnt)));this.focused||(this.focused=!0,this.tagsInput.classList.add("focused"),this.dropdownContainer.classList.add("focused"),evnt=new CustomEvent("tags-input-focus",{bubbles:!0,cancelable:!0}),this.tagsInput.dispatchEvent(evnt))},StorkTagsInput.prototype.onKeyCheckFocus=function(e){this.onClickCheckFocus({target:document.activeElement})},StorkTagsInput.prototype.onChangeSearchInput=function(e){this.input.value!==this.lastSearchString&&("with-tags"===this.inputLi.storkTagsProps.state&&this.calculateSearchInputWidth(),this.suggestionsHandler(this.input.value,this.chosenTags,this.suggestionsCallback.bind(this))),this.lastSearchString=this.input.value},StorkTagsInput.prototype.onKeydownSearchInput=function(event){(event.key&&event.keyCode>=48&&event.keyCode<=90||event.keyCode>=186&&event.keyCode<=222)&&"with-tags"===this.inputLi.storkTagsProps.state&&this.calculateSearchInputWidth(this.input.value+event.key)},StorkTagsInput.prototype.calculateSearchInputWidth=function(text){if("no-tags"===this.inputLi.storkTagsProps.state)return void(this.input.style.width="");if(!this.textCanvasContext){var textCanvas=document.createElement("canvas"),inputStyle=this.input.currentStyle||window.getComputedStyle(this.input);this.textCanvasContext=textCanvas.getContext("2d"),this.textCanvasContext.font=inputStyle.fontStyle+" "+inputStyle.fontWeight+" "+inputStyle.fontSize+" "+inputStyle.fontFamily,this.input.storkTagsProps.paddingLeft=parseInt(inputStyle.paddingLeft,10),this.input.storkTagsProps.paddingRight=parseInt(inputStyle.paddingRight,10)}var textMetrics=this.textCanvasContext.measureText(text||this.input.value);this.input.style.width=Math.ceil(textMetrics.width+this.input.storkTagsProps.paddingLeft+this.input.storkTagsProps.paddingRight+1)+"px"},StorkTagsInput.prototype.onFocusSearchInput=function(e){this.unfocusTags(),this.scrollLIIntoView(this.inputLi),this.onChangeSearchInput()},StorkTagsInput.prototype.onSuggestionsKeyboardNavigate=function(e){var hoveredIndex,allLIs,key=keyboardMap[e.keyCode];0!==this.dropdownContainer.storkTagsProps.allLIs.length&&this.dropdownContainer.classList.contains("focused")&&("DOWN"!==key&&"UP"!==key&&"ENTER"!==key||(e.preventDefault(),hoveredIndex=this.dropdownContainer.storkTagsProps.hoveredLIIndex,allLIs=this.dropdownContainer.storkTagsProps.allLIs,"DOWN"===key?Number.isInteger(hoveredIndex)&&hoveredIndex!==allLIs.length-1?this.onMouseMoveSuggestionsDropdown({target:allLIs[hoveredIndex+1]}):this.onMouseMoveSuggestionsDropdown({target:allLIs[0]}):"UP"===key?Number.isInteger(hoveredIndex)&&0!==hoveredIndex?this.onMouseMoveSuggestionsDropdown({target:allLIs[hoveredIndex-1]}):this.onMouseMoveSuggestionsDropdown({target:allLIs[allLIs.length-1]}):"ENTER"===key&&(Number.isInteger(hoveredIndex)?this.onClickSuggestionsDropdown({target:allLIs[hoveredIndex]}):this.onMouseMoveSuggestionsDropdown({target:allLIs[0]}))))},StorkTagsInput.prototype.onTagsKeyboardNavigate=function(e){var key=keyboardMap[e.keyCode];if("LEFT"===key)this.input===document.activeElement&&this.inputLi.previousSibling&&!Number.isInteger(this.focusedTagIndex)&&0===this.input.selectionStart?this.onClickFocusTag(this.inputLi.previousSibling.index):Number.isInteger(this.focusedTagIndex)&&(this.redrawSearchInput(this.chosenTags[this.focusedTagIndex].elm.offsetLeft-1,this.input.value.length),e.preventDefault());else if("RIGHT"===key)this.input===document.activeElement&&this.inputLi.nextSibling&&!Number.isInteger(this.focusedTagIndex)&&this.input.selectionStart>=this.input.value.length?this.onClickFocusTag(this.inputLi.nextSibling.index-1):Number.isInteger(this.focusedTagIndex)&&(this.redrawSearchInput(this.chosenTags[this.focusedTagIndex].elm.offsetLeft+this.chosenTags[this.focusedTagIndex].elm.clientWidth+1,0),e.preventDefault());else if("BACKSPACE"===key||"DELETE"===key)if(this.input===document.activeElement){if(this.tagDeleteThrottle.allowed&&""===this.input.value)try{"BACKSPACE"===key&&this.inputLi.previousSibling?this.removeTag(this.inputLi.previousSibling.index):"DELETE"===key&&this.inputLi.nextSibling&&this.removeTag(this.inputLi.index)}catch(e){console.warn(e.message)}(""!==this.input.value||this.tagDeleteThrottle.allowed)&&(this.tagDeleteThrottle.allowed=!1,clearTimeout(this.tagDeleteThrottle.TO),this.tagDeleteThrottle.TO=setTimeout(function(){this.tagDeleteThrottle.allowed=!0}.bind(this),400))}else if(Number.isInteger(this.focusedTagIndex)){var tmpFocusedTagIndex=this.focusedTagIndex;this.redrawSearchInput(this.chosenTags[this.focusedTagIndex].elm.offsetLeft-1);try{this.removeTag(tmpFocusedTagIndex)}catch(e){console.warn(e.message)}finally{this.focusSearchInput(0)}e.preventDefault()}},StorkTagsInput.prototype.onKeyboardFocus=function(e){var key=keyboardMap[e.keyCode];"TAB"!==key||e.shiftKey||document.activeElement===this.tagsInput&&this.input.focus()},StorkTagsInput.prototype.unfocusSuggestions=function(){if(Number.isInteger(this.dropdownContainer.storkTagsProps.hoveredLIIndex))this.dropdownContainer.storkTagsProps.allLIs[this.dropdownContainer.storkTagsProps.hoveredLIIndex].classList.remove("focused");else for(var i=0;i<this.dropdownContainer.storkTagsProps.allLIs.length;i++)this.dropdownContainer.storkTagsProps.allLIs[i].classList.contains("focused")&&this.dropdownContainer.storkTagsProps.allLIs[i].classList.remove("focused");this.dropdownContainer.storkTagsProps.hoveredLIIndex=null},StorkTagsInput.prototype.unfocusTags=function(){if(Number.isInteger(this.focusedTagIndex))this.chosenTags[this.focusedTagIndex].elm.classList.remove("focused");else for(var i=0;i<this.chosenTags.length;i++)this.chosenTags[i].elm.classList.contains("focused")&&this.chosenTags[i].elm.classList.remove("focused");this.focusedTagIndex=null},StorkTagsInput.prototype.focusSearchInput=function(caretPosition){Number.isInteger(caretPosition)||(caretPosition=0),this.input.focus();var INP=this.input;INP.setSelectionRange(caretPosition,caretPosition),setTimeout(function(){INP.setSelectionRange(caretPosition,caretPosition)},0)},StorkTagsInput.prototype.destroy=function(){for(this._emptyEventListeners();this.tagsInput.firstChild;)this.tagsInput.removeChild(this.tagsInput.firstChild);for(;this.dropdownContainer.firstChild;)this.dropdownContainer.removeChild(this.dropdownContainer.firstChild);this.dropdownContainer.parentNode.removeChild(this.dropdownContainer),this.tagsInput.classList.remove("stork-tags","stork-tags"+this.rnd),delete this.tagsInput,delete this.inputMinWidth,delete this.rechooseRemove,delete this.placeholder,delete this.chosenTags,delete this.focusedTagIndex,delete this.lastSearchString,delete this.tagDeleteThrottle,delete this.eventListeners},root.StorkTagsInput=StorkTagsInput}(window);
//# sourceMappingURL=tags-input.min.js.map